# 勘测端详细设计

- [勘测详细设计](#勘测详细设计)
  - [一、工程管理](#一-工程管理详细设计)
    - [1.1 上报勘测数据](#11-上报勘测数据)
    - [1.2 获取工程列表](#12-获取工程列表)
    - [1.3 获取工程明细](#13-获取工程明细)
    - [1.4 完成勘察](#14-完成勘察)
    - [1.5 上传交底数据](#15-上传交底数据)
    - [1.6 完成交底](#16-完成交底)

## 一、工程管理

### 1.1 上报勘测数据
 * 实现思路
  > 1. 获取项目信息，状态，工程信息
  > 2. 检查项目状态是否是未勘察或者勘察中
  > 3. 清除勘测数据，清除设计数据，清除拆除数据
  > 4. 上报数据是否为空(可提到第一步执行)
  > 5. 勘测数据处理
      >> 1. 将上传勘测数据的线路型号id=线路型号
      >> 2. 将勘测数据根据线路型号id分组后循环获取每个线路的线材视图信息，并将每条线路的线路型号id赋值为物料id,线路型号=规格型号，类型=物料名称
  > 6. 设计数据处理
      >> 1. 将设计数据的线路型号id=线路型号
      >> 2. 将设计数据根据线路型号id分组后循环获取每个线路的线材视图信息，并将每条线路的线路型号id赋值为物料id,线路型号=规格型号，类型=物料名称
  > 7. 写入勘测数据
      >> 1. 写入杆塔+电缆数据, 循环杆塔数据，将杆塔勘测人员=当前登录人员 ，将杆规格根据*拆分， 分别赋值为杆塔的杆稍劲和杆高，判断杆塔电压等级是否为380或者220，是则将杆塔排列方式赋值为水平，将数据写入勘测_杆塔数据表中
      >> 2. 写入电缆井数据，循环数据，将勘测人员=当前登录人员，将数据写入勘测_电缆井数据表和勘测_电缆井_扩展表中
      >> 3. 写入电缆通道数据，循环数据，将设计人员=当前登录人员，将数据写入勘测_电缆通道数据表中
      >> 4. 写入电缆杆上设备数据，循环数据，将勘测人员=当前登录人员，将数据写入勘测_电缆杆上设备数据表中
      >> 5. 写入架空杆上设备数据，循环数据，将勘测人员=当前登录人员，将数据写入勘测_架空杆上设备数据表中
      >> 6. 写入线路设备数据，循环数据，将勘测人员=当前登录人员,回路标识=回路序列号，将数据写入勘测_线路数据表和勘测_线路数据扩展表中
      >> 7. 写入地物数据，循环数据，将设计人员=当前登录人员，将数据写入勘测_地物数据表中
      >> 8. 写入多媒体数据，循环数据，将设计人员=当前登录人员，将数据写入勘测_多媒体数据表中
  > 8. 写入设计数据
      >> 1. 写入杆塔数据,将杆塔勘测人员=当前登录人员 ，将杆规格根据*拆分， 分别赋值为杆塔的杆稍劲和杆高，判断杆塔电压等级是否为380或者220，是则将杆塔排列方式赋值为水平，将数据写入设计_杆塔数据表中
      >> 2. 写入电缆井数据，循环数据，将勘测人员=当前登录人员，将数据写入设计_电缆井数据表和设计_电缆井_扩展表中
      >> 3. 写入电缆通道数据，循环数据，将设计人员=当前登录人员，将数据写入设计_电缆通道数据表中
      >> 4. 写入电缆杆上设备数据，循环数据，将勘测人员=当前登录人员，将数据写入设计_电缆杆上设备数据表中
      >> 5. 写入架空杆上设备数据，循环数据，将勘测人员=当前登录人员，将数据写入设计_架空杆上设备数据表中
      >> 6. 写入线路设备数据，循环数据，将勘测人员=当前登录人员,回路标识=回路序列号，将数据写入设计_线路数据表和设计_线路数据扩展表中
      >> 7. 写入地物数据，循环数据，将设计人员=当前登录人员，将数据写入设计_地物数据表中
      >> 8. 写入多媒体数据，循环数据，将设计人员=当前登录人员，将数据写入设计_多媒体数据表中
  > 9. 写入拆除数据
      >> 1. 写入杆塔数据,将杆塔勘测人员=当前登录人员 ，将杆规格根据*拆分， 分别赋值为杆塔的杆稍劲和杆高，判断杆塔电压等级是否为380或者220，是则将杆塔排列方式赋值为水平，将数据写入拆除_杆塔数据表中
      >> 2. 写入电缆井数据，循环数据，将勘测人员=当前登录人员，将数据写入拆除_电缆井数据表和拆除_电缆井_扩展表中
      >> 3. 写入电缆通道数据，循环数据，将设计人员=当前登录人员，将数据写入拆除_电缆通道数据表中
      >> 4. 写入电缆杆上设备数据，循环数据，将勘测人员=当前登录人员，将数据写入拆除_电缆杆上设备数据表中
      >> 5. 写入架空杆上设备数据，循环数据，将勘测人员=当前登录人员，将数据写入拆除_架空杆上设备数据表中
      >> 6. 写入线路设备数据，循环数据，将勘测人员=当前登录人员,回路标识=回路序列号，将数据写入拆除_线路数据表和拆除_线路数据扩展表中
      >> 7. 写入地物数据，循环数据，将设计人员=当前登录人员，将数据写入拆除_地物数据表中
      >> 8. 写入多媒体数据，循环数据，将设计人员=当前登录人员，将数据写入拆除_多媒体数据表中
  > 10. 写入轨迹数据
      >> 1. 通过工程编号和轨迹类型未勘察条件删除对应工程轨迹记录
      >> 2. 判断传入轨迹记录是否为空，直接写入工程轨迹记录表中
  > 11. 更新工程状态
      >> 1. 若当前工程状态不等于勘察中，则修改工程状态
          >>> 1. 判断当前是否存在，通过工程id获取工程状态
          >>> 2. 增加一条工程状态日志记录，判断工程状态是否为设计状态，是则将工程状态修改为勘测中；若状态为外部状态，则将其修改为传入状态
  > 12. 将数据同步到postgis
      >> 1. 通过项目id查询数据库获取，【轨迹，电缆井，电缆通道，电缆设备，线路，地物，架空杆上设备，杆塔】数据
      >> 2. 删除Postgis勘察旧数据，拼接sql依次插入所有数据
### 1.2 获取工程列表
  * 实现思路
  > 1. 通过工程管理接口 [勘察端获取项目列表](http://47.108.63.23:8013/api/Project/GetSurveyList)获取列表数据
### 1.3 获取工程明细
   * 实现思路
  > 1. 验证项目信息是否存在，工程信息是否存在，判断是否有操作该工程权限。
  > 2. 查询数据库获取列表数据
### 1.4 完成勘察
  * 实现思路
  > 1. 检查勘测人员操作权限,验证工程和项目是否存在
  > 2. 检查项目状态是否在未勘察或勘察中
  > 3. 修改项目状态为勘察完成，同事通过.netCode CAP发布PublishTemplateNews消息
### 1.5 上传交底数据
  * 实现思路
  > 1. 验证项目信息是否存在，工程信息是否存在，判断是否有操作该工程权限。
  > 2. 检查项目状态
  > 3. 写入交底数据
      >> 1. 循环交底数据，将创建用户=当前登录用户，判断交底状态是否为点位有误同时交底明细不能为空
      >> 2. 循环交底明细，判断明细类别是否为文本，文本属性值为空时抛异常，否则判断文件编号是否为空，空是抛异常
      >> 3. 删除当前项目交底数据,交底明细数据，然后将传入的交底数据，交底明细数据写入数据库
  > 4. 写入轨迹数据 
      >> 1. 删除当前项目工程轨迹记录
      >> 2. 将当前轨迹记录的轨迹类型=交底
      >> 3. 将轨迹记录写入数据库
  > 5. 更改工程状态
  > 6. 轨迹转存postgis
### 1.6 完成交底
  * 实现思路
  > 1. 获取项目信息，项目状态
  > 2. 判断项目状态是否为交底中，判断杆塔，电缆井，电气设备，是否交底完成。修改项目状态为交底完成



   
 



